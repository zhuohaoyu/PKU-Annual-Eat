<template>
  <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-3xl font-bold text-gray-900">ç™¾é²¸å¤§å­¦é£Ÿå ‚æ¶ˆè´¹å¹´åº¦æŠ¥å‘Š</h1>
      <p class="text-gray-600 mt-2">{{ formatDateRange() }}</p>
      <p class="text-sm text-gray-500 mt-4">åˆæ˜¯ä¸€å¹´"å¹²é¥­äºº"ç”Ÿæ´»æŠ¥å‘Š</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-4">
      <div class="bg-white rounded-lg sm:rounded-xl p-2.5 sm:p-6 shadow-sm">
        <div class="flex items-center gap-2">
          <span class="text-lg sm:text-2xl">ğŸ’°</span>
          <div>
            <p class="text-xs sm:text-sm text-gray-600">æ€»æ¶ˆè´¹</p>
            <p class="text-base sm:text-2xl font-bold text-gray-900">Â¥{{ reportData.summary.total_amount.toFixed(1) }}</p>
            <p class="text-[10px] sm:text-xs text-gray-500 mt-0.5">â‰ˆ{{ Math.floor(reportData.summary.total_amount / 15) }}ç¢—å…°å·æ‹‰é¢</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg sm:rounded-xl p-2.5 sm:p-6 shadow-sm">
        <div class="flex items-center gap-2">
          <span class="text-lg sm:text-2xl">ğŸ½ï¸</span>
          <div>
            <p class="text-xs sm:text-sm text-gray-600">æ‰“å¡æ¬¡æ•°</p>
            <p class="text-base sm:text-2xl font-bold text-gray-900">{{ reportData.summary.total_transactions }}</p>
            <div class="flex flex-col text-[10px] sm:text-xs text-gray-500 mt-0.5 leading-tight">
              <p>æ¯å¤© {{ getAveragePerDay().toFixed(1) }}æ¬¡æ¶ˆè´¹, å‡ä»· Â¥{{ getAveragePerMeal().toFixed(1) }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-span-2 sm:col-span-1 bg-white rounded-lg sm:rounded-xl p-2.5 sm:p-6 shadow-sm">
        <div class="flex items-center gap-2">
          <span class="text-lg sm:text-2xl">ğŸ“</span>
          <div>
            <p class="text-xs sm:text-sm text-gray-600">æ¢ç´¢çª—å£</p>
            <p class="text-base sm:text-2xl font-bold text-gray-900">{{ reportData.summary.total_categories }}</p>
            <p class="text-[10px] sm:text-xs text-gray-500 mt-0.5">{{ getExplorerText() }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Locations List -->
    <div class="bg-white rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-sm">
      <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2 sm:mb-4 flex items-center gap-2">
        <span>ğŸ†</span>æ¶ˆè´¹æ’è¡Œæ¦œ
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2">
        <div v-for="(location, index) in getTopLocations()" :key="location.name" 
             class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-1.5 min-w-0">
            <span class="flex-shrink-0 text-sm">{{ getRankEmoji(index) }}</span>
            <div class="truncate">
              <div class="text-sm font-medium truncate">{{ location.name }}</div>
              <div class="text-[10px] text-gray-500">{{ location.visits }}æ¬¡å…‰é¡¾</div>
            </div>
          </div>
          <div class="text-xs font-semibold text-gray-900 flex-shrink-0 ml-1">
            Â¥{{ location.amount.toFixed(1) }}
          </div>
        </div>
      </div>
    </div>

    <!-- Analysis Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Time Distribution -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <span>â°</span>å°±é¤æ—¶é—´åˆ†å¸ƒ
        </h3>
        <p class="text-sm text-gray-500 mb-4">{{ getTimeHabitText() }}</p>
        <div class="h-[300px]">
          <EatingTimeHeatmap :transactions="reportData.transactions" />
        </div>
      </div>
      
      <!-- Location Distribution -->
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-2 flex items-center gap-2">
          <span>ğŸª</span>å°±é¤åœ°ç‚¹åˆ†å¸ƒ
        </h3>
        <p class="text-sm text-gray-500 mb-4">{{ getLocationText() }}</p>
        <div class="h-[300px]">
          <LocationAnalysis :transactions="reportData.transactions" />
        </div>
      </div>
    </div>

    <!-- Unusual Transactions -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-2 flex items-center gap-2">
        <span>âœ¨</span>éš¾å¿˜æ—¶åˆ»
      </h3>
      <p class="text-sm text-gray-500 mb-4">è¿™äº›æ—¶åˆ»ï¼Œå€¼å¾—è¢«è®°ä½</p>
      <UnusualTransactions 
        :transactions="reportData.transactions"
        :special-transactions="reportData.special_transactions" 
      />
    </div>

    <!-- Footer -->
    <div class="text-center text-sm text-gray-500 pt-4">
      <p>ä»Šå¹´çš„æ•…äº‹å†™åœ¨è¿™é‡Œï¼Œæ˜å¹´çš„ç²¾å½©è¿˜åœ¨ç»§ç»­</p>
      <p class="mt-2">Generated by PKU Dining Report</p>
    </div>
  </div>
</template>

<script>
import EatingTimeHeatmap from './EatingTimeHeatmap.vue'
import LocationAnalysis from './LocationAnalysis.vue'
import UnusualTransactions from './UnusualTransactions.vue'

export default {
  components: {
    EatingTimeHeatmap,
    LocationAnalysis,
    UnusualTransactions
  },
  props: {
    reportData: {
      type: Object,
      required: true
    }
  },
  methods: {
    formatDateRange() {
      const startDate = new Date(this.reportData.transactions[0].OCCTIME)
      const endDate = new Date(this.reportData.transactions[this.reportData.transactions.length - 1].OCCTIME)
      return `${startDate.getFullYear()}å¹´${startDate.getMonth() + 1}æœˆ - ${endDate.getFullYear()}å¹´${endDate.getMonth() + 1}æœˆ`
    },

    getRankingText() {
      const count = this.reportData.summary.total_transactions;
      if (count > 800) return "å‰1%";
      if (count > 600) return "å‰5%";
      if (count > 400) return "å‰20%";
      return "ä¸­ç­‰";
    },

    getExplorerText() {
      const count = this.reportData.summary.total_categories;
      if (count >= 20) return "é£Ÿå ‚æ¢ç´¢å®¶ğŸ†";
      if (count >= 15) return "ç¾é£Ÿè¾¾äººğŸŒŸ";
      if (count >= 10) return "åˆçº§æ¢ç´¢è€…ğŸ¯";
      return "è¿˜æœ‰å¾…æ¢ç´¢";
    },

    getTimeHabitText() {
      // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…æ•°æ®åˆ†æå¾—å‡ºç”¨é¤è§„å¾‹
      return "ä½ æ˜¯ä¸ªè§„å¾‹çš„é£Ÿå®¢ï¼Œæ€»èƒ½åœ¨æœ€ä½³æ—¶æ®µæ‰¾åˆ°ç¾é£Ÿ";
    },

    getLocationText() {
      // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…æ•°æ®åˆ†æå¾—å‡ºå»åœ°ç‚¹
      return "è¿™é‡Œè®°å½•ç€ä½ çš„æ¯ä¸€æ¬¡è¶³è¿¹ï¼Œä¹Ÿè®¸è¿˜æœ‰å’Œæœ‹å‹ç›¸èšçš„æ¸©æš–æ—¶å…‰";
    },

    getRankEmoji(index) {
      const emojis = ['ğŸ†', 'ğŸ¥ˆ', 'ğŸ¥‰', 'âœ¨', 'ğŸŒŸ']
      return emojis[index]
    },

    getTopLocations() {
      const locationStats = {}
      
      this.reportData.transactions.forEach(trans => {
        if (trans.TRANAMT >= 0) return
        
        const location = trans.MERCNAME.trim()
        if (!locationStats[location]) {
          locationStats[location] = {
            name: location,
            amount: 0,
            visits: 0
          }
        }
        locationStats[location].amount += Math.abs(parseFloat(trans.TRANAMT))
        locationStats[location].visits++
      })

      return Object.values(locationStats)
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 5)
    },

    getAveragePerMeal() {
      const totalAmount = this.reportData.summary.total_amount;
      const totalTransactions = this.reportData.summary.total_transactions;
      return totalAmount / totalTransactions;
    },

    getAveragePerDay() {
      const totalTransactions = this.reportData.summary.total_transactions;
      const totalDays = 365;
      return totalTransactions / totalDays;
    }
  }
}
</script> 